#! /usr/bin/perl -w

use strict;
use FindBin;

# For testing, change name of $dest_file...

my $dest_file = $ARGV[0] || '/etc/cron.d/tuttle_job';
my $temp_file = $dest_file . '.new'; # Vixie cron won't run '.new' crontabs

# Identify name of "gold" module that we're running out of, which
# may be "tuttle", or may be something else, for testing purposes...

$FindBin::Bin =~ m|/([^/]+)/bin$|;

my $module_name = $1;

# Job runs after 9:00 PM, at a random minute...

my $rmin = sprintf("%02d", int(rand(60)));

open (OUT, ">$temp_file") or die "Couldn't create $temp_file";

(print OUT <<EOF) or die "Couldn't write $temp_file";
# Automatically generated by /gold/$module_name/bin/install

MAILTO=sysadmin

export PATH=/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/usr/local/sbin:\$PATH

$rmin 21 * * * root   goldpull $module_name; /gold/$module_name/bin/tuttle-master-job
EOF

(close OUT) or die "Couldn't write $temp_file";

(rename $temp_file, $dest_file) or die "Couldn't install $dest_file";

