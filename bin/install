#! /usr/bin/perl -w

#    Tuttle --- Tiny Utility Toolkit for Tweaking Large Environments
#    Copyright (C) 2007  Smartleaf, Inc.
#
#    This program is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License along
#    with this program; if not, write to the Free Software Foundation, Inc.,
#    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.

use strict;
use FindBin;

# For testing, change name of $dest_file...

my $dest_file = $ARGV[0] || '/etc/cron.d/tuttle_job';
my $temp_file = $dest_file . '.new'; # Vixie cron won't run '.new' crontabs

# Identify name of "gold" module that we're running out of, which
# may be "tuttle", or may be something else, for testing purposes...

$FindBin::Bin =~ m|/([^/]+)/bin$|;

my $module_name = $1;

# Job runs after 9:00 PM, at a random minute...

my $rmin = sprintf("%02d", int(rand(60)));

open (OUT, ">$temp_file") or die "Couldn't create $temp_file";

(print OUT <<EOF) or die "Couldn't write $temp_file";
# Automatically generated by /gold/$module_name/bin/install

MAILTO=sysadmin

PATH=/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/usr/local/sbin

$rmin 21 * * * root   goldpull $module_name; /gold/$module_name/bin/tuttle-master-job
EOF

(close OUT) or die "Couldn't write $temp_file";

(rename $temp_file, $dest_file) or die "Couldn't install $dest_file";

